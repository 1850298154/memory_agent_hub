## 参考
https://www.cnblogs.com/maidongdong/p/18878779
Elasticsearch 默认使用 **BM25 相似度模型**（以前版本使用 TF-IDF）来计算文档的评分。BM25 是一个基于词频、文档长度和查询词重要性的概率模型。评分计算主要基于以下因素：

#### 关键因素
1.  **词频（Term Frequency, TF）**：
    -   查询词在文档中出现的频率越高，评分越高。
    -   但 BM25 对词频有饱和机制（即多次出现的效果会逐渐减弱）。
2.  **逆文档频率（Inverse Document Frequency, IDF）**：
    -   查询词在索引中的稀有程度。词越稀有（出现在越少的文档中），IDF 越高，评分贡献越大。
3.  **字段长度归一化（Field Length Normalization）**：
    -   文档字段的长度越短，评分越高（因为短字段中的词更重要）。
4.  **查询协调因子（Query Coordination Factor）**：
    -   如果查询包含多个词，匹配更多查询词的文档会获得额外的评分加成。
5.  **其他因素**：
    -   如果使用 `boost` 参数，某些字段或查询的权重会增加。
    -   自定义评分函数（如 `function_score`）可能会修改评分。

https://juejin.cn/post/7500238824268283914
Elasticsearch 默认使用一种称为实际评分函数（BM25）的评分模型。这个模型基于概率信息检索理论，并考虑以下因素：词频、逆文档频率和字段长度归一化。我们简单介绍这些因素：

-   **词频（TF）**：表示一个词在文档中出现的次数。词频越高，说明这个词与该文档的关系越强。
    
-   **逆文档频率（IDF）**：衡量一个词在整个文档集合中的重要性。出现在很多文档中的词被认为不太重要，而出现在较少文档中的词则更重要。
    
-   **字段长度归一化**：考虑词出现的字段长度。较短字段的词会被赋予更高权重，因为在较短字段中出现的词更具代表性。


https://www.geeksforgeeks.org/nlp/what-is-bm25-best-matching-25-algorithm/


### 参考曲线：
https://elasticstack.blog.csdn.net/article/details/104132454


##  Elasticsearch 中的评分算法
在 Elasticsearch 中，文档评分（Score）默认使用 **BM25 算法**（而非传统的 TF-IDF），但也支持其他评分模型（如 TF-IDF、LM Dirichlet 等）。以下是 Elasticsearch 中核心评分公式的详细解析：


### 一、默认评分算法：BM25
BM25 是对 TF-IDF 的改进，解决了 TF-IDF 中词频（TF）无上限导致权重过高的问题。其核心公式如下：

#### 1. 单字段评分公式
```
score(q, d) = Σ [ IDF(t) × (TF(t,d) × (k1 + 1)) / (TF(t,d) + k1 × (1 - b + b × |d|/avgdl)) ) ]
```
- **Σ**：对查询中所有词项（term）的评分求和。
- **t**：查询中的某个词项。
- **d**：被评分的文档。


#### 2. 公式中各参数含义
| 符号               | 含义                                                                 | 作用                                                                 |
|--------------------|----------------------------------------------------------------------|----------------------------------------------------------------------|
| **score(q, d)**    | 文档 d 与查询 q 的匹配得分                                           | 最终评分，越高表示匹配度越好                                         |
| **IDF(t)**         | 词项 t 的逆文档频率（Inverse Document Frequency）                    | 衡量词项的稀缺性，稀有词项（如专业术语）权重更高                       |
| **TF(t,d)**        | 词项 t 在文档 d 中的词频（Term Frequency）                           | 衡量词项在文档中的出现次数，出现越多权重越高（但受限于 k1 控制）       |
| **k1**             | 调节词频饱和度的参数（默认 1.2）                                     | 控制 TF 增长的上限，解决 TF-IDF 中 TF 无限增长的问题（如 k1=1.2 时，TF 超过一定值后权重增长放缓） |
| **b**              | 调节文档长度对评分影响的参数（默认 0.75）                            | 平衡长文档的优势，避免长文档因包含更多词项而获得不当高分               |
| **|d|**             | 文档 d 的长度（词项总数）                                            | 用于归一化不同长度文档的评分                                         |
| **avgdl**          | 索引中所有文档的平均长度                                             | 作为文档长度的基准，用于计算相对长度                                 |


#### 3. IDF(t) 的计算公式
```
IDF(t) = log( (N + 1) / df(t) )
```
- **N**：索引中的总文档数。
- **df(t)**：包含词项 t 的文档数（文档频率）。
- 作用：稀有词项（df(t) 小）的 IDF 更高，例如“量子计算”比“技术”的 IDF 高。


### 二、TF-IDF 算法（非默认，可手动启用）
TF-IDF 是传统的评分算法，Elasticsearch 中可通过配置使用。公式如下：

```
score(q, d) = Σ [ TF(t,d) × IDF(t) ]
```
- **TF(t,d)**：词项 t 在文档 d 中的词频（直接使用出现次数，无上限）。
- **IDF(t)**：同 BM25，通常为 `log(N / df(t))`。


### 三、BM25 对 TF-IDF 的改进
1. **解决 TF 无上限问题**：  
   TF-IDF 中 TF 随词项出现次数线性增长，可能导致“的”“是”等高频词权重过高。BM25 通过 `k1` 控制 TF 增长的饱和度（类似“S型曲线”），当 TF 超过一定值后，权重增长放缓。

2. **平衡文档长度影响**：  
   TF-IDF 中长文档可能因包含更多词项而得分偏高（即使相关性低）。BM25 通过 `b` 和 `avgdl` 归一化文档长度，惩罚过长文档的不合理优势。

3. **更合理的 IDF 计算**：  
   BM25 的 IDF 公式 `log((N+1)/df(t))` 避免了 df(t)=0 时的除以零错误（TF-IDF 中 `log(N/0)` 无意义）。


### 四、多字段评分（如 _all 字段或 multi_match 查询）
当查询涉及多个字段时，Elasticsearch 会先计算每个字段的 BM25 得分，再通过以下方式合并：
```
score(q, d) = Σ [ field_weight × score_field(q, d) ]
```
- **field_weight**：字段权重（可通过 `boost` 参数设置，默认 1.0）。
- **score_field(q, d)**：单个字段的 BM25 得分。


### 总结
- Elasticsearch 默认使用 **BM25**，通过 `k1`、`b` 等参数优化了 TF-IDF 的缺陷，更适合实际检索场景。
- 核心思想：平衡词频、文档频率和文档长度，使评分更符合用户对“相关性”的直观理解。
- 可通过 `similarity` 参数在映射（mapping）中指定字段使用的评分算法（如 `BM25`、`classic`（TF-IDF）等）。

## 对比
### TF-IDF 与 BM25 公式对比及问题解决分析

#### 一、核心公式对比
| 算法   | 核心评分公式                                                                 | 适用场景                     |
|--------|------------------------------------------------------------------------------|------------------------------|
| TF-IDF | `score(q,d) = Σ [ TF(t,d) × IDF(t) ]`                                        | 早期信息检索、简单文本匹配   |
| BM25   | `score(q,d) = Σ [ IDF(t) × (TF(t,d)×(k1+1)) / (TF(t,d) + k1×(1-b + b×丨d丨/avgdl)) ) ]` | 现代搜索引擎（Elasticsearch默认） |


#### 二、公式中核心指标的差异
| 指标         | TF-IDF 定义                          | BM25 定义                                                                 |
|--------------|--------------------------------------|--------------------------------------------------------------------------|
| **TF(t,d)**  | 词项 t 在文档 d 中的出现次数（无上限） | 经过饱和度处理的词频：`TF(t,d)×(k1+1) / (TF(t,d) + k1×(...))`            |
| **IDF(t)**   | `log(N / df(t))`                     | `log((N + 1) / df(t))`（避免除零错误）                                  |
| **文档长度** | 无专门处理                           | 通过 `b` 和 `avgdl` 归一化：`1 - b + b × |d| / avgdl`                    |


#### 三、解决的问题对比

##### 1. TF-IDF 原本解决的问题
TF-IDF 是对“词频（TF）”的改进，核心解决**“高频词无区分度”**的问题：
- **原始词频（TF）的缺陷**：仅统计词项出现次数，导致“的”“是”等常见词权重过高（因为出现次数多），而稀有但重要的词（如“量子计算”）被掩盖。
- **TF-IDF 的改进**：通过 **IDF（逆文档频率）** 惩罚常见词（出现文档多的词 IDF 低），提升稀有词的权重。例如：
  - 词“的”在 90% 文档中出现 → IDF 极低 → 对评分贡献小。
  - 词“区块链”仅在 1% 文档中出现 → IDF 极高 → 对评分贡献大。


##### 2. BM25 对 TF-IDF 的进一步解决
BM25 针对 TF-IDF 的缺陷优化，解决了三个核心问题：

| TF-IDF 的缺陷                          | BM25 的解决方式                                                                 | 效果示例                                                                 |
|----------------------------------------|--------------------------------------------------------------------------------|--------------------------------------------------------------------------|
| **TF 无上限导致权重膨胀**              | 通过 `k1` 控制 TF 饱和度：<br>当 TF 增大到一定程度后，评分增长放缓（类似“S型曲线”） | 若 `k1=1.2`，词项出现 5 次与 10 次的评分差异，远小于出现 1 次与 5 次的差异。 |
| **长文档不当获利**                     | 通过 `b` 和 `avgdl` 归一化文档长度：<br>长文档的词频权重被适当降低              | 一篇 10000 字的文档和一篇 500 字的文档，若包含相同词项，后者可能得分更高（更相关）。 |
| **IDF 计算可能出现除零错误**           | IDF 公式改为 `log((N+1)/df(t))`，避免 `df(t)=0` 时的无意义计算                  | 当某词项在所有文档中都不出现（`df(t)=0`），BM25 仍能计算（`log(N+1)`），而 TF-IDF 会出错。 |


#### 四、总结：两者的递进关系
1. **TF-IDF** 解决了“高频常见词权重过高”的问题，通过 IDF 区分词项的重要性。
2. **BM25** 在 TF-IDF 基础上，进一步解决了“词频无限增长”“长文档偏见”“极端情况计算错误”等问题，使评分更符合实际检索场景的相关性需求。

这也是 Elasticsearch 选择 BM25 作为默认评分算法的核心原因——在处理真实世界的文本数据时，BM25 的评分结果更贴近用户对“相关性”的直观理解。
