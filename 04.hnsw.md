## hnswlib
#### API 说明

- `HNSWLIB.Index（space， dim）` 在空间`space`中创建一个未初始化的索引，即具有整数维度 `dim` 的 HNSW。

`HNSWLIB 的索引`方法：

- `init_index(max_elements, M = 16, ef_construction = 200, random_seed = 100, allow_replace_deleted = False)` 初始化索引，不带任何元素。
  - `max_elements` 定义了结构中可以存储的最大元素数（可以增加/缩小）。
  - `ef_construction` 定义了构建时间/精度的权衡（参见 [ALGO_PARAMS.md](https://github.com/nmslib/hnswlib/blob/master/ALGO_PARAMS.md)）。
  - `M` 定义图 （[ALGO_PARAMS.md](https://github.com/nmslib/hnswlib/blob/master/ALGO_PARAMS.md)） 中传出连接的最大数量。
  - `allow_replace_deleted` 允许用新添加的元素替换已删除的元素。
- `add_items(data, ids, num_threads = -1, replace_deleted = False)` - 将`数据 `（向量的 numpy 数组，形状：`N*dim`）插入到结构中。
  - `num_threads` 设置要使用的 CPU 线程数（-1 表示使用默认值）。
  - `ids` 是`数据`中所有元素的可选 N 大小 numpy 整数标签数组。
    - 如果 index 已经具有具有相同标签的元素，则它们的功能将被更新。请注意，更新过程比插入新元素慢，但内存和查询效率更高。
  - `replace_deleted` 替换已删除的元素。请注意，它允许节省内存。
    - 要使用它 `init_index` 应该使用 `allow_replace_deleted=True` 调用
  - 与其他 `add_items` 调用的线程安全，但对 `knn_query` 不安全。
- `mark_deleted（label）` - 将元素标记为已删除，因此它将从搜索结果中省略。如果已删除异常，则引发异常。
- `unmark_deleted（label）` - 取消将元素标记为已删除，因此不会从搜索结果中省略它。
- `resize_index（new_size）` - 更改索引的最大容量。`add_items` 和 `knn_query` 不符合线程安全。
- `set_ef（ef）` - 设置查询时间精度/速度权衡，由 `ef` 参数 （ [ALGO_PARAMS.md](https://github.com/nmslib/hnswlib/blob/master/ALGO_PARAMS.md)）中。请注意，该参数目前不会与索引一起保存，因此您需要在加载后手动设置。
- `knn_query(data, k = 1, num_threads = -1, filter = None)` 对 `k` 个最接近的元素进行批量查询
  - `data` （shape：`N*dim`）。返回 （shape：`N*k`） 的 numpy 数组。
  - `num_threads` 设置要使用的 CPU 线程数（-1 表示使用默认值）。
  - `filter` 按标签过滤元素，返回具有允许 ID 的元素。请注意，在多线程模式下，使用过滤器进行搜索在 python 中运行缓慢。建议设置 `num_threads=1`
  - 与其他 `knn_query` 调用的线程安全，但对 `add_items` 不安全。
- 将索引 `load_index(path_to_index, max_elements = 0, allow_replace_deleted = False)` 从持久性加载到未初始化的索引。
  - `max_elements`（可选）重置结构中元素的最大数量。
  - `allow_replace_deleted` 指定正在加载的索引是否启用了对已删除元素的替换。
- `save_index（path_to_index）` 将索引从持久性中保存出来。
- `set_num_threads（num_threads）` 设置数据插入/查询时使用的默认 CPU 线程数。
- `get_items(ids, return_type = 'numpy')` - 返回一个 numpy 数组 （shape：`N*dim`），其中包含在 `ids` numpy vector （shape：`N`） 中指定的整数标识符 `return_type 如果是``列表`返回列表列表。请注意，对于余弦相似性，它当前返回**归一化**向量。
- `get_ids_list（）` - 返回所有元素 ID 的列表。
- `get_max_elements（）` - 返回索引的当前容量
- `get_current_count（）` - 返回存储在索引中的当前元素数

hnswlib 的只读属性 `索引`类：

- `space` - 空间的名称（可以是“L2”、“IP”或“cosine”之一）。
- `昏暗 ` - 空间的维度。
- `M` - 定义图中最大传出连接数的参数。
- `ef_construction` - 在索引构建过程中控制速度/精度权衡的参数。
- `max_elements` - 指数的当前容量。相当于 `p.get_max_elements（）。`
- `element_count` - 索引中的项目数。相当于 `p.get_current_count（）。`

`hnswlib 的属性。` 支持读写的索引：

- `ef` - 控制查询时间/精度权衡的参数。
- `num_threads` - 在 `add_items` 或 `knn_query` 中使用的默认线程数。请注意，调用 `p.set_num_threads（3）` 相当于 `p.num_threads=3`。


#### ALGO_PARAMS.md
[ALGO_PARAMS.md](https://github.com/nmslib/hnswlib/blob/master/ALGO_PARAMS.md)

**HNSW** **算法参数**

 **搜索参数：**

- ef （优先队列长度）最近邻的动态列表的大小（在搜索期间使用）。更高的 ef 导致更准确但更慢的搜索。ef 不能设置为低于查询的最近邻数 k 的值 ef 可以是介于 k 和数据集大小之间的任何值。
- k 个要作为结果返回的最近邻。knn_query 函数返回两个 numpy 数组，其中包含标签和到查询找到的最近元素的 k 个元素的距离。请注意，如果算法无法找到所有查询的 k 个邻居（这可能是由于数据集的图形或 k>size 问题），则会抛出异常。

可以在 [TESTING_RECALL.md](https://github.com/nmslib/hnswlib/blob/master/TESTING_RECALL.md) 中找到调整参数的示例

 **构建参数：**

- M - 在构造过程中为每个新元素创建的双向链接数。M 的合理范围 是 2-100。较高的 M 在具有高内在维度和/或高召回率的数据集中效果更好，而低 M 更适用于具有低内在维度和/或低召回率的数据集。该参数还确定算法的内存消耗，每个存储元素大约为 M * 8-10 字节。
    - 例如，对于 dim=4 随机向量，搜索的最佳 M 约为 6，而对于高维数据集（单词嵌入、良好的人脸描述符），需要更高的 M（例如 M=48-64）才能在高召回率下获得最佳性能。对于大多数用例，M=12-48 范围是可以的。当 M 发生变化时，必须更新其他参数。尽管如此，可以通过假设 M*ef_{construction} 是一个常数来粗略估计 ef 和 ef_construction 参数。
- ef_construction - 该参数与 ef 具有相同的含义，但控制 index_time/index_accuracy。ef_construction 越大，构造时间越长，但索引质量越好。在某些时候，增加 ef_construction 并不能提高索引的质量。检查 ef_construction 选择是否正常的一种方法是在 ef =ef_construction 时测量 M 个最近邻搜索的召回率：如果召回率低于 0.9，则有改进的余地。
- num_elements - 定义索引中元素的最大数量。可以通过保存/加载来扩展索引（load_index 函数有一个参数，用于定义新的最大元素数）。

 


##
在HNSW中，对IP（内积）取1 - IP，对L2（欧氏距离）取1 - L2**2，主要是为了将距离度量转换为相似度度量，使得数值越大表示越相似。以下是具体解释：
- **内积（IP）**：内积本身的值越大，表示两个向量越相似。但在HNSW中，为了遵循距离度量的一般概念，即距离越小越相似，所以采用1 - IP的形式。这样，原本内积大的情况，经过转换后得到的数值也大，符合相似度度量的直观理解，即数值越大越相似。例如，两个向量内积为0.8，那么1 - 0.8 = 0.2；若内积为0.9，1 - 0.9 = 0.1，0.1小于0.2，说明内积为0.9的两个向量更相似。
- **欧氏距离（L2）**：欧氏距离是衡量两个向量之间的直线距离，距离越小表示两个向量越相似。L2**2表示欧氏距离的平方，同样，为了将其转换为相似度度量，采用1 - L2**2的形式。这样，欧氏距离越小，L2**2的值越小，1 - L2**2的值就越大，也就表示两个向量越相似。比如，两个向量的欧氏距离为1，L2**2 = 1，1 - 1 = 0；若欧氏距离为0.5，L2**2 = 0.25，1 - 0.25 = 0.75，0.75大于0，说明欧氏距离为0.5的两个向量更相似。